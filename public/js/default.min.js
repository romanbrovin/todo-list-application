const toast=new bootstrap.Toast(".toast"),toastTimeout=500;function redirect(e="reload"){setTimeout(function(){"reload"===e?location.reload():location.href=e},toastTimeout)}function showToast(e,t){$(".toast").removeClass(function(e,t){return(t.match(/(^|\s)text-bg-\S+/g)||[]).join(" ")}),$(".toast").addClass("text-bg-"+t),$(".toast-body").html(e),toast.show()}function actionTask(o){let n=new Object,i=(n.token2=token2,$.each($("#form").serializeArray(),function(e,t){n[t.name]=t.value}),$("input:checkbox:checked").each(function(){n[$(this).attr("name")]=1}),$(".btn__"+o));i.prop("disabled",!0),loader(),$.ajax({type:"POST",url:"/"+o,data:n,statusCode:{404:function(){errorToken()}}}).done(function(e){$(".is-invalid").removeClass("is-invalid");let t="";if("ok"===e)"create"==o?t="Задача создана":"save"==o&&(t="Задача изменена"),showToast(t,"success"),redirect("/");else{var n=JSON.parse(e);if(0<n.length){for(var a in t="&nbsp;&nbsp;Необходимо ввести:</strong>",n)t+="<br>&mdash;&nbsp;&nbsp;"+$("#"+n[a]+"~ .feedback-short").html(),$("#"+n[a]).addClass("is-invalid");showToast(t,"danger")}i.prop("disabled",!1),loader(0)}})}function taskDone(e){let t=new Object;t.token2=token2,t.id=e,$("input:checkbox:checked").each(function(){t[$(this).attr("name")]=1}),loader(),$.ajax({type:"POST",url:"/done",data:t,statusCode:{404:function(){errorToken()}}}).done(function(e){$(".is-invalid").removeClass("is-invalid");"ok"===e&&(showToast("Задача выполена","success"),redirect())})}function loginUser(){let n=new Object,o=(n.token2=token2,$.each($("#form").serializeArray(),function(e,t){n[t.name]=t.value}),$(".btn__login"));o.prop("disabled",!0),loader(),$.ajax({type:"POST",url:"/login",data:n,statusCode:{404:function(){errorToken()}}}).done(function(e){$(".is-invalid").removeClass("is-invalid");let t="";if("ok"===e)showToast(t="Вы успешно авторизованы","success"),redirect("/");else{var n=JSON.parse(e);if(0<n.length){if("auth"==n)t="Имя пользователя или пароль введены неправильно",$(".form-control").addClass("is-invalid");else for(var a in t="&nbsp;&nbsp;Необходимо ввести:</strong>",n)t+="<br>&mdash;&nbsp;&nbsp;"+$("#"+n[a]+"~ .feedback-short").html(),$("#"+n[a]).addClass("is-invalid");showToast(t,"danger")}o.prop("disabled",!1),loader(0)}})}function loader(e){event&&event.preventDefault(),0===e?$(".loader").fadeOut(200):$(".loader").fadeIn(200)}function parseUrl(e){var t=document.createElement("a");return t.href=e,t}function errorToken(){redirect("/auth")}function log(e){return console.log(e)}$(function(){uri=$("#uri").val(),token2=$("#token2").val(),$.each($("#form").serializeArray(),function(e,t){$("[name="+t.name+"]").on("input",function(e){let t=$(this).attr("placeholder");var n=$(this).attr("maxlength"),a=$(this).val().length;n&&0<a&&(t=t+" "+a+"/"+n),$(this).next("label").html(t)})}),$(".s_query").click(function(){event.preventDefault(),q=$(this).attr("data-query"),pathname=parseUrl(location.href).pathname,location.href=pathname+"?q="+q}),$(".btn__create").click(function(){actionTask("create")}),$(".btn__save").click(function(){actionTask("save")}),$(".btn__login").click(function(){loginUser()}),$(".btn__done").click(function(){taskDone($(this).closest(".item").attr("id"))}),$(".btn__edit").click(function(){loader(),redirect("/edit?id="+$(this).closest(".item").attr("id"))})});